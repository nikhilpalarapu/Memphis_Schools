<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Memphis Schools – Memphis Only</title>

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- MarkerCluster -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Papa Parse -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Fuse.js -->
    <script src="https://unpkg.com/fuse.js@6.6.2"></script>

    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Turf.js -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --card: #1f2937;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --brand: #22d3ee;
        --accent: #60a5fa;
        --pill: rgba(255, 255, 255, 0.95);
        --pill-border: #111827;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, "Noto Sans", "Helvetica Neue", Arial;
      }

      /* ===== Layout ===== */
      #app {
        display: grid;
        grid-template-columns: 340px 1fr;
        grid-template-rows: 1fr;
        height: 100svh;
        overflow: hidden;
      }
      #sidebar {
        background: linear-gradient(
          180deg,
          rgba(31, 41, 55, 0.85),
          rgba(17, 24, 39, 0.95)
        );
        backdrop-filter: blur(6px);
        border-right: 1px solid #1f2937;
        padding: 16px;
        overflow: auto;
      }
      #mapWrap {
        position: relative;
        height: 100%;
        width: 100%;
      }
      #map {
        position: absolute;
        inset: 0;
        background: #fff;
      }

      /* ===== Mobile top bar ===== */
      .topbar {
        display: none;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 10px 12px;
        background: rgba(17, 24, 39, 0.98);
        border-bottom: 1px solid #1f2937;
        position: relative;
        z-index: 5;
      }
      .topbar h1 {
        font-size: 16px;
        margin: 0;
        font-weight: 700;
      }
      .topbar .btn {
        white-space: nowrap;
      }

      .h1 {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 8px;
      }
      .muted {
        color: var(--muted);
        font-size: 12px;
      }
      .card {
        background: var(--card);
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 12px;
      }

      .controls label {
        display: block;
        font-size: 13px;
        margin: 8px 0 4px;
      }
      input[type="text"],
      input[type="number"] {
        width: 100%;
        box-sizing: border-box;
        background: #0b1220;
        border: 1px solid #1f2937;
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        outline: none;
      }
      input[type="text"]:focus,
      input[type="number"]:focus {
        border-color: var(--brand);
      }

      .chips {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .chip {
        background: #0b1220;
        border: 1px solid #1f2937;
        color: var(--text);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        cursor: pointer;
      }
      .chip.active {
        border-color: var(--brand);
        color: #67e8f9;
      }

      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .row > * {
        flex: 1;
      }

      .btn {
        background: linear-gradient(135deg, var(--brand), var(--accent));
        color: #0b1220;
        border: 0;
        padding: 10px 12px;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        white-space: nowrap;
      }
      .btn.secondary {
        background: #0b1220;
        color: var(--text);
        border: 1px solid #1f2937;
      }

      .legend {
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 12px;
      }
      .dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        vertical-align: middle;
      }

      .dot.critical {
        background: #3b82f6;
      } /* BLUE for critical */
      .dot.atrisk {
        background: #ef4444;
      } /* RED for at risk   */
      .dot.other {
        background: #10b981;
      }
      .count {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }

      .tooltip-title {
        font-weight: 700;
      }
      .popup dl {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 6px 12px;
        margin: 8px 0 0;
      }
      .popup dt {
        color: var(--muted);
      }
      .popup dd {
        margin: 0;
      }

      /* Labels */
      .county-label {
        display: none;
        border: none;
        background: transparent;
      }
      .county-label span {
        display: inline-block;
        background: var(--pill);
        border: 1px solid var(--pill-border);
        border-radius: 6px;
        padding: 2px 8px;
        font-size: 12px;
        color: #111827;
        line-height: 1.2;
        white-space: nowrap;
      }

      /* Directory Overlay */
      #directory {
        position: absolute;
        inset: 0 0 0 340px;
        background: linear-gradient(
          180deg,
          rgba(31, 41, 55, 0.98),
          rgba(17, 24, 39, 0.98)
        );
        border-left: 1px solid #1f2937;
        backdrop-filter: blur(6px);
        display: none;
        z-index: 600;
        overflow: auto;
      }
      #directory .header {
        position: sticky;
        top: 0;
        z-index: 2;
        background: rgba(17, 24, 39, 0.98);
        border-bottom: 1px solid #1f2937;
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 10px;
        align-items: center;
        padding: 12px 16px;
      }
      #directory .title {
        font-size: 16px;
        font-weight: 700;
      }
      #directory .searchbar input {
        width: 100%;
        background: #0b1220;
        border: 1px solid #1f2937;
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
      }
      #dirContent {
        padding: 16px;
      }
      .section {
        background: var(--card);
        border: 1px solid #1f2937;
        border-radius: 12px;
        margin-bottom: 16px;
        overflow: hidden;
      }
      .section h3 {
        margin: 0;
        padding: 10px 12px;
        font-size: 14px;
        background: #0b1220;
        border-bottom: 1px solid #1f2937;
      }
      .list {
        display: grid;
        gap: 2px;
        padding: 8px;
      }
      .item {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        align-items: center;
        background: #0f1526;
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 8px 10px;
        cursor: pointer;
      }
      .item:hover {
        border-color: var(--brand);
      }
      .item .name {
        font-weight: 600;
      }
      .item .meta {
        color: var(--muted);
        font-size: 12px;
      }

      /* Hide map controls while directory open */
      body.directory-open .leaflet-control-container {
        display: none !important;
      }

      /* Mini HUD (legend + filter summary) — TOP RIGHT */
      #miniHUD {
        position: absolute;
        left: 12px;
        top: 12px;
        z-index: 550;
        background: rgba(17, 24, 39, 0.9);
        border: 1px solid #1f2937;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        font-size: 12px;
        backdrop-filter: blur(4px);
      }
      #miniHUD .legend {
        gap: 6px;
      }
      #miniHUD .summary {
        color: var(--text);
        opacity: 0.9;
      }

      /* Loading overlay */
      #loading {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 800;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(2px);
      }
      .spinner {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        border: 4px solid rgba(255, 255, 255, 0.25);
        border-top-color: #67e8f9;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .loading-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        background: rgba(17, 24, 39, 0.95);
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 18px 22px;
        color: var(--text);
      }

      /* Empty-state overlay */
      #emptyState {
        position: absolute;
        inset: auto 12px 12px 12px;
        z-index: 540;
        display: none;
      }
      .empty-card {
        background: rgba(17, 24, 39, 0.95);
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 14px 16px;
        color: var(--text);
        font-size: 14px;
      }

      /* North indicator (top-left) */
      #north {
        position: absolute;
        right: 12px;
        left: auto;
        top: 12px;
        z-index: 545;
        width: 28px;
        height: 28px;
        opacity: 0.85;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #111827;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #north svg {
        display: block;
      }

      /* Search suggestions under the filter search */
      #searchWrap {
        position: relative;
      }
      #searchSuggestions {
        position: absolute;
        left: 0;
        right: 0;
        top: 100%;
        margin-top: 6px;
        z-index: 20;
        display: none;
        background: var(--panel);
        border: 1px solid #1f2937;
        border-radius: 10px;
        max-height: 260px;
        overflow: auto;
      }
      .suggestion {
        padding: 8px 10px;
        cursor: pointer;
        border-bottom: 1px solid #1f2937;
      }
      .suggestion:last-child {
        border-bottom: none;
      }
      .suggestion:hover {
        background: #0b1220;
      }

      /* ====== Responsive ====== */
      @media (max-width: 1200px) {
        #app {
          grid-template-columns: 300px 1fr;
        }
        #directory {
          inset: 0 0 0 300px;
        }
      }
      @media (max-width: 900px) {
        #app {
          grid-template-columns: 1fr;
        }
        .topbar {
          display: flex;
        }
        #sidebar {
          position: fixed;
          left: 0;
          top: 0;
          height: 100svh;
          width: min(92vw, 420px);
          transform: translateX(-105%);
          transition: transform 0.25s ease;
          z-index: 700;
          border-right: 1px solid #1f2937;
          border-radius: 0;
        }
        #sidebar.open {
          transform: translateX(0);
        }
        #mapWrap {
          height: calc(100svh - 56px);
        } /* 56px topbar */
        #directory {
          inset: 0;
        } /* full-screen directory on mobile */
      }
      @media (max-width: 420px) {
        .btn {
          padding: 12px 14px;
        }
        input[type="text"],
        input[type="number"] {
          padding: 12px;
        }
        .chip {
          padding: 8px 12px;
        }
      }

      /* Dim overlay behind slide-in sidebar (mobile) */
      #backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        backdrop-filter: blur(2px);
        display: none;
        z-index: 650;
      }
      #backdrop.show {
        display: block;
      }

      #leadLegend {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      #leadLegend .legend-row {
        display: flex;
        align-items: center; /* center, not stretch */
        gap: 8px;
        line-height: 1.25;
      }
      #leadLegend .legend-row .dot {
        flex: 0 0 auto; /* extra safety for older browsers */
      }

      #leadLegend .legend-row span:last-child {
        font-size: 12px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- Mobile top bar -->
      <div class="topbar">
        <h1>Memphis Schools</h1>
        <div style="display: flex; gap: 8px">
          <button id="btnFilters" class="btn secondary" title="Open filters">
            Filters
          </button>
          <button
            id="openDirectoryMobile"
            class="btn"
            title="Browse schools list"
          >
            Directory
          </button>
        </div>
      </div>

      <!-- Slide-over backdrop (mobile) -->
      <div id="backdrop"></div>

      <!-- Sidebar -->
      <aside id="sidebar" aria-label="Filters and tools">
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
          "
        >
          <h1 class="h1">Memphis Schools</h1>
          <div
            style="
              display: flex;
              gap: 8px;
              flex-wrap: nowrap;
              align-items: center;
            "
          >
            <button
              id="openDirectory"
              class="btn secondary"
              title="Browse schools list"
            >
              Directory
            </button>
            <!-- Apply Filters button removed (auto-apply) -->
            <button id="resetBtn" class="btn" title="Clear filters">
              Reset
            </button>
          </div>
        </div>
        <div class="muted">
          Hover a pin for a quick name. Click for full details.
        </div>

        <div class="card controls" id="searchWrap">
          <label for="search">Search school</label>
          <input
            id="search"
            type="text"
            placeholder="Type to search… (e.g., Whitehaven)"
            autocomplete="off"
          />
          <div class="muted" style="margin-top: 6px">
            Start typing to see schools (prefix match). Press Enter to jump to
            the top match.
          </div>
          <div id="searchSuggestions"></div>
        </div>

        <div class="card controls">
          <label>Lead risk category</label>
          <div id="conditionChips" class="chips"></div>
          <div class="legend" id="leadLegend" style="margin-top: 8px">
            <div class="legend-row">
              <span class="dot critical" aria-hidden="true"></span>
              <span
                >Schools built before 1978 that may contain lead-based paint and
                lead water lines</span
              >
            </div>
            <div class="legend-row">
              <span class="dot atrisk" aria-hidden="true"></span>
              <span
                >Schools built 1978–1988 that may contain lead water line or
                lead solder</span
              >
            </div>
          </div>

          <div class="count" id="visibleCount"></div>
        </div>

        <div class="card controls">
          <label for="ageMin">Age range (years)</label>
          <div class="row">
            <input id="ageMin" type="number" value="0" min="0" step="1" />
            <input id="ageMax" type="number" value="200" min="0" step="1" />
          </div>
          <div class="muted" style="margin-top: 6px">
            Filters rows where <em>Age</em> is between the two values.
          </div>
          <div class="legend" style="margin-top: 8px">
            <span class="dot other" aria-hidden="true"></span>
            <span
              >Cluster of nearby schools — click to open schools and built
              years</span
            >
          </div>
        </div>
      </aside>

      <!-- Map area -->
      <div id="mapWrap">
        <main id="map"></main>

        <!-- North indicator -->
        <div id="north" title="North">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M12 3l4 8h-8l4-8zm0 18v-8"
              fill="#111827"
              stroke="#111827"
              stroke-width="1"
            />
          </svg>
        </div>

        <!-- Mini HUD (top-right) -->
        <div id="miniHUD" role="status" aria-live="polite">
          <div class="legend">
            <span class="dot critical" title="Pre-1978 (Blue)"></span>
            <span class="dot atrisk" title="1978–1988 (Red)"></span>
          </div>
          <div class="summary" id="miniSummary">Filters: —</div>
        </div>

        <!-- Empty state -->
        <div id="emptyState">
          <div class="empty-card">No results — try clearing filters.</div>
        </div>

        <!-- Directory (overlay) -->
        <section id="directory" aria-hidden="true">
          <div class="header">
            <div class="title">Directory</div>
            <div class="searchbar">
              <input
                id="dirSearch"
                type="text"
                placeholder="Search by school name…"
              />
            </div>
            <div style="text-align: right">
              <button id="closeDirectory" class="btn">Back to Map</button>
            </div>
          </div>
          <div id="dirContent">
            <div class="section">
              <h3>Pre-1978</h3>
              <div id="listCritical" class="list"></div>
            </div>
            <div class="section">
              <h3>1978-1988</h3>
              <div id="listAtRisk" class="list"></div>
            </div>
          </div>
        </section>

        <!-- Loading overlay -->
        <div id="loading" aria-hidden="true">
          <div class="loading-card">
            <div class="spinner"></div>
            <div id="loadingText">Loading…</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      (() => {
        // === CONFIG ===
        const DATA_URL = "final_updated_105_schools.xlsx";
        const MEMPHIS_GEOJSON_URL = "memandshelbyshapefile.geojson";
        const START_ZOOM = 10.5;
        const TARGET_ZOOM = 16.5; // tighter zoom on selection

        const COUNTY_NAME_MAP = {
          1: "Amber Mills",
          2: "David C. Bradford, Jr",
          3: "Mick Wright",
          4: "Brandon Morrison",
          5: "Shante Avant",
          6: "Charlie Caswell Jr",
          7: "Henri E. Brooks",
          8: "Mickell Lowery",
          9: "Edmund Ford, Jr",
          10: "Britney Thornton",
          11: "Miska Clay-Bibbs",
          12: "Erika Sugarmon",
          13: "Michael Whaley",
        };

        const SHOW_DISTRICT_LABELS = false;

        // === Loading overlay helpers ===
        const loadingEl = document.getElementById("loading");
        const loadingTextEl = document.getElementById("loadingText");
        function showLoading(show, text) {
          loadingTextEl.textContent = text || "Loading…";
          loadingEl.style.display = show ? "flex" : "none";
          loadingEl.setAttribute("aria-hidden", show ? "false" : "true");
        }

        // === MAP INIT ===
        const map = L.map("map", { zoomControl: false });
        L.control.zoom({ position: "bottomright" }).addTo(map);
        L.control.scale({ position: "bottomleft" }).addTo(map); // scale control

        // Icons (Blue = Critical; Red = At Risk)
        const BlueIcon = new L.Icon({
          iconUrl: "./marker-icon.png",
          iconRetinaUrl: "./marker-icon-2x.png",
          shadowUrl: "./marker-shadow.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          tooltipAnchor: [16, -28],
          shadowSize: [41, 41],
        });
        const RedIcon = new L.Icon({
          iconUrl: "./marker-icon-red.png",
          iconRetinaUrl: "./marker-icon-red-2x.png",
          shadowUrl: "./marker-shadow.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          tooltipAnchor: [16, -28],
          shadowSize: [41, 41],
        });

        // White mask pane
        map.createPane("maskPane");
        map.getPane("maskPane").style.zIndex = 350;

        const base = L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            maxZoom: 19,
            attribution: "&copy; OpenStreetMap contributors",
          }
        ).addTo(map);

        // === STATE ===
        let allRows = [];
        let fuse = null;
        let memphisLayer = null,
          countyLineLayer = null,
          memphisMaskLayer = null;
        let countyLabelLayer = L.layerGroup();
        let memphisFeature = null;
        let districtPolys = []; // [{ feature: <GeoJSON Feature>, name: 'Amber Mills' }, ...]
        let dataLoaded = false; // XLSX loaded?
        let boundaryLoaded = false; // GeoJSON loaded?

        // Fly/pan to a target and keep loader up until tiles for the new view are ready
        function flyToAndWait(targetLatLng, zoom, duration = 0.8) {
          return new Promise((resolve) => {
            let moved = false;
            let tilesReady = false;
            let waiting = true;

            function maybeDone() {
              if (moved && tilesReady) {
                resolve();
              }
            }

            // 1) When the camera finishes
            map.once("moveend", () => {
              moved = true;
              maybeDone();
            });

            // 2) When tiles for the current view finish
            const done = () => {
              if (!waiting) return;
              waiting = false;
              tilesReady = true;
              base.off("load", done);
              maybeDone();
            };

            // If the base layer is (or becomes) loading, wait for its 'load'
            if (base._loading || (base._tilesToLoad && base._tilesToLoad > 0)) {
              base.once("load", done);
            } else {
              // Tiles may be cached & ready synchronously — settle next tick
              setTimeout(done, 0);
            }

            // Kick off the motion
            map.flyTo(targetLatLng, zoom, { duration });
          });
        }

        function maybeEnrich() {
          // When both data and boundary are ready, compute row.District once
          if (dataLoaded && boundaryLoaded) {
            enrichRowsWithDistricts();
            render();
            refreshDirectory?.(); // only if you have Directory; otherwise safe to keep
          }
        }

        const clusterGroup = L.markerClusterGroup({
          showCoverageOnHover: false,
          maxClusterRadius: 48,
          spiderfyOnMaxZoom: true,
        }).addTo(map);

        const conditionSet = new Set();
        const conditionChipsEl = document.getElementById("conditionChips");
        const visibleCountEl = document.getElementById("visibleCount");

        const miniSummaryEl = document.getElementById("miniSummary");
        const emptyStateEl = document.getElementById("emptyState");

        const markerByKey = new Map(); // School|Label -> marker
        const markerByLabel = new Map(); // Label -> marker (for sharable hash)
        function keyForRow(r) {
          return `${String(r.School || "").trim()}|${String(
            r.Label || ""
          ).trim()}`;
        }

        // === HELPERS ===
        function isCritical(cond) {
          return String(cond || "")
            .toLowerCase()
            .includes("critical");
        }

        function findDistrictNameFor(lat, lon) {
          if (!districtPolys.length || !isFinite(lat) || !isFinite(lon))
            return null;
          const pt = turf.point([lon, lat]);
          for (const { feature, name } of districtPolys) {
            try {
              if (turf.booleanPointInPolygon(pt, feature)) return name;
            } catch {}
          }
          return null;
        }

        function isAtRisk(cond) {
          const v = String(cond || "").toLowerCase();
          return v.includes("risk") && !v.includes("critical");
        }

        function escapeHtml(v) {
          return String(v ?? "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function leadCategoryFor(year) {
          const y = +year;
          if (!isFinite(y)) return "—";
          if (y < 1978) return "Pre-1978";
          if (y >= 1978 && y <= 1988) return "1978–1988";
          return "—";
        }

        function leadCategoryFor(yearBuilt) {
          const y = +yearBuilt;
          if (!isFinite(y)) return null;
          if (y < 1978) return "Pre-1978";
          if (y >= 1978 && y <= 1988) return "1978–1988";
          return null; // outside the requested risk windows
        }

        function enrichRowsWithDistricts() {
          for (const r of allRows) {
            const lat = Number(r.Latitude),
              lon = Number(r.Longitude);
            r.District = findDistrictNameFor(lat, lon) || "—";
          }
        }

        function rowToMarker(row) {
          const lat = +row.Latitude,
            lon = +row.Longitude;
          if (!isFinite(lat) || !isFinite(lon)) return null;
          if (!row.LeadCategory) return null; // show only our two lead windows

          // Blue = Pre-1978, Red = 1978–1988
          const icon = row.LeadCategory === "1978–1988" ? RedIcon : BlueIcon;

          const m = L.marker([lat, lon], { icon });
          m.bindTooltip(
            `<span class="tooltip-title">${escapeHtml(row.School)}</span>`,
            { sticky: true, direction: "top", offset: [0, -8] }
          );
          m.bindPopup(`
    <div class="popup">
      <div style="font-weight:700;font-size:14px;margin-bottom:6px;">${escapeHtml(
        row.School
      )}</div>
      <dl>
        <dt>Lead category</dt><dd>${escapeHtml(row.LeadCategory || "—")}</dd>
        <dt>Year Built</dt><dd>${escapeHtml(row.YearBuilt)}</dd>
        <dt>Age</dt><dd>${escapeHtml(row.Age)}</dd>
        <dt>District</dt><dd>${escapeHtml(row.District || "—")}</dd>
      </dl>
    </div>`);
          return m;
        }

        function pulseAt(lat, lon) {
          // subtle 2s pulse using two circles
          const c1 = L.circle([lat, lon], {
            radius: 70,
            color: "#67e8f9",
            weight: 2,
            opacity: 0.7,
            fillOpacity: 0.15,
          });
          const c2 = L.circle([lat, lon], {
            radius: 30,
            color: "#67e8f9",
            weight: 2,
            opacity: 0.9,
            fillOpacity: 0.25,
          });
          c1.addTo(map);
          c2.addTo(map);
          setTimeout(() => {
            try {
              map.removeLayer(c1);
            } catch {}
            try {
              map.removeLayer(c2);
            } catch {}
          }, 2000);
        }

        function buildChips() {
          conditionChipsEl.innerHTML = "";
          ["Pre-1978", "1978–1988"].forEach((val) => {
            const el = document.createElement("button");
            el.type = "button";
            el.className = "chip active";
            el.textContent = val;
            el.dataset.value = val;
            el.addEventListener("click", () => {
              el.classList.toggle("active");
              applyFilters(true);
            });
            conditionChipsEl.appendChild(el);
          });
        }

        function activeConditions() {
          const out = [];
          for (const el of conditionChipsEl.querySelectorAll(".chip"))
            if (el.classList.contains("active")) out.push(el.dataset.value);
          return out;
        }
        function getAgeBounds() {
          const min = +(document.getElementById("ageMin").value || "0");
          const max = +(document.getElementById("ageMax").value || "999");
          return [min, max];
        }

        function passesFilters(row) {
          const [amin, amax] = getAgeBounds();
          const a = +row.Age;
          if (isFinite(amin) && a < amin) return false;
          if (isFinite(amax) && a > amax) return false;

          const act = activeConditions(); // lead categories now
          if (!row.LeadCategory) return false; // outside 1978 windows
          return act.includes(row.LeadCategory);
        }

        function getCountyName(props = {}) {
          const nameFields = [
            "NAMELSAD",
            "NAME",
            "Name",
            "name",
            "LABEL",
            "LABEL_NAME",
            "DISTRICT",
            "COUNCIL_DI",
            "COUNCIL_DIST",
            "DIST_NUM",
          ];
          for (const k of nameFields) {
            const v = props[k];
            if (v != null) {
              const s = String(v);
              const m = s.match(/dist(?:rict)?\s*(\d{1,2})/i);
              if (m && COUNTY_NAME_MAP[m[1]]) return COUNTY_NAME_MAP[m[1]];
            }
          }
          const codeFields = [
            "DISTRICT",
            "COUNCIL_DI",
            "COUNCIL_DIST",
            "COUNTYFP",
            "GEOID",
            "ID",
            "CODE",
            "name",
          ];
          for (const k of codeFields) {
            if (props[k] != null) {
              const code = String(props[k]).trim();
              if (COUNTY_NAME_MAP[code]) return COUNTY_NAME_MAP[code];
            }
          }
          const readableFields = ["NAMELSAD", "NAME", "Name", "name"];
          for (const k of readableFields) {
            const v = props[k];
            if (v != null && /[A-Za-z]/.test(String(v))) {
              return (
                String(v)
                  .replace(/dist(?:rict)?\s*\d{1,2}/i, "")
                  .trim() || "District"
              );
            }
          }
          return "District";
        }

        function pointInsideMemphis(lat, lon) {
          if (!memphisFeature) return true;
          try {
            const pt = turf.point([lon, lat]);
            if (memphisFeature.type === "FeatureCollection") {
              return memphisFeature.features.some((f) =>
                turf.booleanPointInPolygon(pt, f)
              );
            }
            return turf.booleanPointInPolygon(pt, memphisFeature);
          } catch {
            return true;
          }
        }

        function updateMiniSummary(visibleCount) {
          const act = activeConditions(); // lead categories
          const [amin, amax] = getAgeBounds();
          const leadText = act.length ? act.join(", ") : "—";
          const ageText = `Age ${amin}–${amax}`;
          const parts = [];
          if (leadText && leadText !== "—") parts.push(leadText);
          if (ageText) parts.push(ageText);
          const body = parts.length ? parts.join(", ") : "—";
          miniSummaryEl.textContent = `Filters: ${body} (${visibleCount} schools)`;
        }

        function render() {
          clusterGroup.clearLayers();
          markerByKey.clear();
          markerByLabel.clear();
          let rows = allRows
            .filter(passesFilters)
            .filter((r) => pointInsideMemphis(+r.Latitude, +r.Longitude));
          for (const r of rows) {
            const m = rowToMarker(r);
            if (m) {
              clusterGroup.addLayer(m);
              markerByKey.set(keyForRow(r), m);
              if (r.Label != null) markerByLabel.set(String(r.Label).trim(), m);
            }
          }
          visibleCountEl.textContent = `${rows.length} of ${allRows.length} visible`;
          updateMiniSummary(rows.length);
          // Empty state
          emptyStateEl.style.display = rows.length ? "none" : "block";
          return rows.length;
        }

        // === Data ===
        async function loadData(url) {
          const lower = url.toLowerCase();
          showLoading(true, "Loading schools…");
          try {
            if (lower.endsWith(".xlsx") || lower.endsWith(".xls")) {
              const resp = await fetch(url, { cache: "no-store" });
              if (!resp.ok) throw new Error(`Failed to fetch ${url}`);
              const buf = await resp.arrayBuffer();
              const wb = XLSX.read(buf, { type: "array" });
              const sheet = wb.SheetNames[0];
              const json = XLSX.utils.sheet_to_json(wb.Sheets[sheet], {
                defval: null,
              });
              handleRows(json);
            } else {
              await new Promise((resolve, reject) => {
                Papa.parse(url, {
                  download: true,
                  header: true,
                  dynamicTyping: true,
                  complete: (r) => {
                    try {
                      handleRows(r.data);
                      resolve();
                    } catch (e) {
                      reject(e);
                    }
                  },
                  error: reject,
                });
              });
            }
          } finally {
            showLoading(false);
          }
        }

        function handleRows(rowsRaw) {
          const rows = rowsRaw
            .filter(
              (r) => r && r.School && r.Latitude != null && r.Longitude != null
            )
            .map((r) => ({
              Label: r.Label,
              School: r.School,
              YearBuilt: r.YearBuilt,
              Age: r.Age,
              Condition: r.Condition || "Unknown", // left in place so nothing else breaks
              LeadCategory: leadCategoryFor(r.YearBuilt),
              Latitude: +r.Latitude,
              Longitude: +r.Longitude,
            }));

          allRows = rows;
          dataLoaded = true;
          maybeEnrich(); // will enrich once boundary is ready
          conditionSet.clear();
          for (const r of rows)
            conditionSet.add(String(r.Condition || "Unknown"));
          buildChips();
          fuse = new Fuse(rows, {
            keys: ["School"],
            threshold: 0.3,
            ignoreLocation: true,
          });

          wireSearchTypeahead(rows);
          wireEnterJump();

          applyFilters(false); // first render
          refreshDirectory();
          // Try hash deep-link after first render
          handleHashLink();
        }

        function wireEnterJump() {
          const input = document.getElementById("search");
          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              const q = e.target.value.trim();
              if (!q || !fuse) return;
              const res = fuse.search(q);
              if (res.length) {
                const r = res[0].item;
                jumpToSchool(r, true); // also set hash
              }
            }
          });
        }

        // Type-ahead suggestions (prefix match on School)
        function wireSearchTypeahead(rows) {
          const input = document.getElementById("search");
          const box = document.getElementById("searchSuggestions");
          function hide() {
            box.style.display = "none";
            box.innerHTML = "";
          }
          function show() {
            box.style.display = "block";
          }

          input.addEventListener("input", () => {
            const v = input.value.trim().toLowerCase();
            if (!v) {
              hide();
              return;
            }
            // prefix-only, alphabetical
            const list = rows
              .filter((r) =>
                String(r.School || "")
                  .toLowerCase()
                  .startsWith(v)
              )
              .sort((a, b) => String(a.School).localeCompare(String(b.School)))
              .slice(0, 50);

            if (!list.length) {
              hide();
              return;
            }
            box.innerHTML = "";
            for (const r of list) {
              const div = document.createElement("div");
              div.className = "suggestion";
              div.textContent = r.School;
              div.addEventListener("click", () => {
                input.value = r.School;
                hide();
                jumpToSchool(r, true); // updates hash too
              });
              box.appendChild(div);
            }
            show();
          });

          // click-away
          document.addEventListener("click", (e) => {
            if (!box.contains(e.target) && e.target !== input) {
              hide();
            }
          });
        }

        async function jumpToSchool(r, setHash) {
          if (!r) return;
          const lat = +r.Latitude,
            lon = +r.Longitude;
          if (setHash && r.Label != null) {
            location.hash = `#id=${encodeURIComponent(String(r.Label).trim())}`;
          }
          showLoading(true, "Locating…");
          closeSidebarMobile();
          showDirectory(false);
          try {
            if (isFinite(lat) && isFinite(lon)) {
              // Wait for camera AND tiles to finish
              await flyToAndWait([lat, lon], TARGET_ZOOM, 0.8);
              const m = markerByKey.get(keyForRow(r));
              if (m) m.openPopup();
              pulseAt(lat, lon);
            }
          } finally {
            showLoading(false);
          }
        }

        // === Boundary, labels & mask ===
        async function loadMemphisBoundary() {
          showLoading(true, "Loading map…");
          try {
            const resp = await fetch(MEMPHIS_GEOJSON_URL, {
              cache: "no-store",
            });
            if (!resp.ok) {
              console.warn("Boundary GeoJSON not found.");
              return;
            }
            const gj = await resp.json();

            if (memphisLayer) map.removeLayer(memphisLayer);
            if (countyLineLayer) map.removeLayer(countyLineLayer);
            if (memphisMaskLayer) map.removeLayer(memphisMaskLayer);
            countyLabelLayer.clearLayers();

            memphisLayer = L.geoJSON(gj, {
              style: { color: "#000", weight: 2, fillOpacity: 0 },
            }).addTo(map);
            countyLineLayer = L.geoJSON(gj, {
              style: { color: "#000", weight: 1, fillOpacity: 0 },
            }).addTo(map);

            const feats =
              gj.type === "FeatureCollection"
                ? gj.features
                : [
                    gj.type === "Feature"
                      ? gj
                      : { type: "Feature", geometry: gj },
                  ];
            const ok = feats.filter((f) => f && f.geometry && f.geometry.type);
            try {
              let merged = ok[0];
              for (let i = 1; i < ok.length; i++)
                merged = turf.union(merged, ok[i]);
              memphisFeature = merged;
            } catch {
              memphisFeature = { type: "FeatureCollection", features: ok };
            }

            // Build the list of district polygons + their display names
            districtPolys = [];
            for (const f of feats) {
              if (!f || !f.geometry) continue;
              try {
                const name = getCountyName(f.properties); // already in your code
                districtPolys.push({ feature: f, name });
              } catch {}
            }

            // (Optional) draw labels only if enabled
            if (SHOW_DISTRICT_LABELS) {
              for (const f of feats) {
                if (!f || !f.geometry) continue;
                try {
                  const c = turf.centerOfMass(f);
                  const [lon, lat] = c.geometry.coordinates;
                  const name = getCountyName(f.properties);
                  const label = L.divIcon({
                    className: "county-label",
                    html: `<span>${name}</span>`,
                    iconSize: null,
                    iconAnchor: [0, 0],
                  });
                  L.marker([lat, lon], {
                    icon: label,
                    interactive: false,
                  }).addTo(countyLabelLayer);
                } catch {}
              }
            }

            try {
              const world = turf.bboxPolygon([-179.999, -85, 179.999, 85]);
              const holeTarget =
                memphisFeature.type === "FeatureCollection"
                  ? ok.reduce((acc, f, idx) =>
                      idx === 0 ? f : turf.union(acc, f)
                    )
                  : memphisFeature;
              const diff = turf.difference(world, holeTarget);
              if (diff) {
                memphisMaskLayer = L.geoJSON(diff, {
                  pane: "maskPane",
                  style: {
                    color: "#fff",
                    weight: 0,
                    fillColor: "#fff",
                    fillOpacity: 1,
                    interactive: false,
                  },
                }).addTo(map);
              }
            } catch {
              console.warn("Mask difference failed; showing outline only.");
            }

            try {
              const center = turf.centerOfMass(memphisFeature);
              const [clon, clat] = center.geometry.coordinates;
              map.setView([clat, clon], START_ZOOM);
              const b = memphisLayer.getBounds();
              if (b.isValid()) map.setMaxBounds(b.pad(0.5));
            } catch {}
          } finally {
            showLoading(false);
            map.invalidateSize();
          }
          boundaryLoaded = true;
          maybeEnrich();
        }

        // === Directory ===
        const directoryEl = document.getElementById("directory");
        const dirSearchEl = document.getElementById("dirSearch");
        const listCriticalEl = document.getElementById("listCritical");
        const listAtRiskEl = document.getElementById("listAtRisk");

        function showDirectory(show) {
          directoryEl.style.display = show ? "block" : "none";
          directoryEl.setAttribute("aria-hidden", show ? "false" : "true");
          document.body.classList.toggle("directory-open", show);
          if (show) {
            dirSearchEl.value = "";
            refreshDirectory();
            dirSearchEl.focus();
          }
          setTimeout(() => map.invalidateSize(), 50);
        }

        function refreshDirectory() {
          let rows = allRows
            .filter(passesFilters)
            .filter((r) => pointInsideMemphis(+r.Latitude, +r.Longitude));

          const pre = rows
            .filter((r) => r.LeadCategory === "Pre-1978")
            .sort((a, b) => String(a.School).localeCompare(String(b.School)));

          const mid = rows
            .filter((r) => r.LeadCategory === "1978–1988")
            .sort((a, b) => String(a.School).localeCompare(String(b.School)));

          const q = dirSearchEl.value.trim().toLowerCase();
          const f = (arr) =>
            q
              ? arr.filter((r) => String(r.School).toLowerCase().includes(q))
              : arr;

          buildList(listCriticalEl, f(pre));
          buildList(listAtRiskEl, f(mid));
        }

        function buildList(container, rows) {
          container.innerHTML = "";
          for (const r of rows) {
            const div = document.createElement("div");
            div.className = "item";

            // Use r.LeadCategory if your data already has it; otherwise fall back to helper.
            const leadCat =
              (r.LeadCategory && String(r.LeadCategory)) ||
              (typeof leadCategoryFor === "function"
                ? leadCategoryFor(r.YearBuilt)
                : "—");

            div.innerHTML = `
      <div>
        <div class="name">${escapeHtml(r.School)}</div>
        <div class="meta">Built ${escapeHtml(
          r.YearBuilt ?? "—"
        )} · Lead risk category: ${escapeHtml(leadCat)}</div>
      </div>
      <div class="meta">Age ${escapeHtml(r.Age ?? "—")}</div>`;

            div.addEventListener("click", () => {
              jumpToSchool(r, true);
            });
            container.appendChild(div);
          }
        }

        // === Apply filters (auto with loader) ===
        function applyFilters(showLoader) {
          if (showLoader) showLoading(true, "Applying filters…");
          setTimeout(() => {
            render();
            refreshDirectory();
            if (showLoader) showLoading(false);
            // On mobile, close the filters panel after applying
            closeSidebarMobile();
          }, 30);
        }

        // === Load ===
        loadMemphisBoundary();
        loadData(DATA_URL);

        // === UI wiring ===
        document
          .getElementById("ageMin")
          .addEventListener("change", () => applyFilters(true));
        document
          .getElementById("ageMax")
          .addEventListener("change", () => applyFilters(true));

        document.getElementById("resetBtn").addEventListener("click", () => {
          for (const chip of conditionChipsEl.querySelectorAll(".chip"))
            chip.classList.add("active");
          document.getElementById("ageMin").value = 0;
          document.getElementById("ageMax").value = 200;
          document.getElementById("search").value = "";
          document.getElementById("searchSuggestions").style.display = "none";
          applyFilters(true);
        });

        // Directory open/close
        document
          .getElementById("openDirectory")
          .addEventListener("click", () => {
            closeSidebarMobile();
            showDirectory(true);
          });
        document
          .getElementById("openDirectoryMobile")
          .addEventListener("click", () => {
            closeSidebarMobile();
            showDirectory(true);
          });
        document
          .getElementById("closeDirectory")
          .addEventListener("click", () => showDirectory(false));
        dirSearchEl.addEventListener("input", refreshDirectory);

        // === Mobile sidebar toggle ===
        const sidebar = document.getElementById("sidebar");
        const backdrop = document.getElementById("backdrop");
        const btnFilters = document.getElementById("btnFilters");

        function openSidebarMobile() {
          sidebar.classList.add("open");
          backdrop.classList.add("show");
          setTimeout(() => map.invalidateSize(), 200);
        }
        function closeSidebarMobile() {
          sidebar.classList.remove("open");
          backdrop.classList.remove("show");
          setTimeout(() => map.invalidateSize(), 200);
        }
        btnFilters.addEventListener("click", () => {
          if (sidebar.classList.contains("open")) closeSidebarMobile();
          else openSidebarMobile();
        });
        backdrop.addEventListener("click", closeSidebarMobile);

        // Close slide-over on Esc (mobile or directory)
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            if (directoryEl.style.display === "block") showDirectory(false);
            closeSidebarMobile();
          }
        });

        // Invalidate map on resize/orientation change for responsiveness
        let resizeTimer = null;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(() => map.invalidateSize(), 150);
        });

        // === Sharable links: #id=<Label> ===
        function handleHashLink() {
          const h = location.hash || "";
          const m = h.match(/#id=([^&]+)/i);
          if (m) {
            const label = decodeURIComponent(m[1]).trim();
            const marker = markerByLabel.get(label);
            if (marker) {
              // Find row via marker reverse map (approx using lat/lng)
              const { lat, lng } = marker.getLatLng();
              const row = allRows.find(
                (r) => +r.Latitude === lat && +r.Longitude === lng
              );
              if (row) jumpToSchool(row, false); // hash already set
            }
          }
        }
        window.addEventListener("hashchange", handleHashLink);
      })();
    </script>
  </body>
</html>
